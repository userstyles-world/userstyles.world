#!/usr/bin/env bash

log() { printf "%s\n" "$@"; }

invalid() { printf "Invalid option: %s\n" "$*"; }

check_cmd() {
    if ! command -v "$1" >/dev/null; then
        log "Missing '$1'!"
        return 1
    fi
}

check_air() {
    if ! command -v air >/dev/null; then
        log "Missing 'air'! Install it with 'go get -u github.com/cosmtrek/air'"
        exit
    fi
}

check_dir() {
    pwd="$(pwd)"
    pwd="${pwd/*\/}"
    if [ $pwd = "tools" ]; then
        cd ..
    fi
}

prod() {
    log "prod"
    check_dir
    env PORT=":${2:-3001}" \
        DB="${3:-prod.db}" \
        SALT="${4:15}" \
        JWT_SIGNING_KEY="$(cat ./.auth)"
        ./userstyles.world
}

sass() {
    log "sass"
    check_cmd sassc
    [ $? = 1 ] && exit
    check_cmd inotifywait
    [ $? = 1 ] && exit

    check_dir
    while inotifywait -r -e close_write scss; do
        sassc --style compressed ./scss/main.scss ./static/css/main.css
    done
}

drop() {
    log "drop"
    check_air
    env DB_DROP="1" \
        DB_COLOR="true" \
        DB_DEBUG="${2:-silent}" \
        air
}

dev() {
    log "dev"
    check_air
    check_dir
    env DB_DEBUG="${2:-silent}" \
        DB_DROP="${3:-false}" \
        DB_COLOR="true" \
        JWT_SIGNING_KEY="$(cat ./.auth)"
        air
}

build() {
    log "build"
    check_dir
    go build
    strip ./userstyles.world # Remove debug symbols
}

case "$1" in
    build) build "$a" ;;
    dev)  dev    "$@" ;;
    drop) drop   "$@" ;;
    prod) prod   "$@" ;;
    sass) sass   "$@" ;;
    *) invalid   "$@" ;;
esac
